{% extends "base.html" %}

{% block title %}Reorder Readings{% endblock %}

{% block extra_css %}
<style>
    .sortable-ghost {
        opacity: 0.4;
        background: #c8ebfb;
    }
    .sortable-chosen {
        background: #f8f9fa;
    }
    .drag-handle {
        cursor: grab;
        color: #6c757d;
        padding: 0.5rem;
    }
    .drag-handle:hover {
        color: #212529;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .category-card {
        margin-bottom: 1rem;
    }
    .category-header {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .category-header .drag-handle {
        margin-right: 0.5rem;
    }
    .reading-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #eee;
        background: white;
    }
    .reading-item:last-child {
        border-bottom: none;
    }
    .reading-item .drag-handle {
        margin-right: 0.75rem;
    }
    .reading-title {
        flex: 1;
    }
    .reading-meta {
        color: #6c757d;
        font-size: 0.85rem;
    }
    .save-indicator {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 0.75rem 1.5rem;
        background: #198754;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: none;
        z-index: 1000;
    }
    .empty-category {
        padding: 1rem;
        color: #6c757d;
        font-style: italic;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-arrows-move me-2"></i>Reorder Readings</h1>
    <a href="{% url 'readings:list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to Readings
    </a>
</div>

<p class="text-muted mb-4">
    <i class="bi bi-info-circle me-1"></i>
    Drag and drop to reorder. Changes are saved automatically.
    This order determines the "Previous" and "Next" navigation on the public reading pages.
</p>

<!-- Categories (sortable) -->
<div id="categories-list">
    {% for category in categories %}
    <div class="card category-card" data-category-id="{{ category.pk }}">
        <div class="category-header">
            <span class="drag-handle category-handle">
                <i class="bi bi-grip-vertical"></i>
            </span>
            <h6 class="mb-0 flex-grow-1">
                <i class="bi bi-folder me-1"></i>
                {{ category.name }}
            </h6>
            <span class="badge bg-secondary">{{ category.readings.count }}</span>
        </div>
        <div class="readings-list" data-category-id="{{ category.pk }}">
            {% for reading in category.readings.all %}
            <div class="reading-item" data-reading-id="{{ reading.pk }}">
                <span class="drag-handle reading-handle">
                    <i class="bi bi-grip-vertical"></i>
                </span>
                <span class="reading-title">{{ reading.title }}</span>
            </div>
            {% empty %}
            <div class="empty-category">No readings in this category</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% if uncategorized_readings %}
<div class="card category-card mt-4">
    <div class="category-header">
        <h6 class="mb-0 flex-grow-1">
            <i class="bi bi-collection me-1"></i>
            Uncategorized
        </h6>
        <span class="badge bg-secondary">{{ uncategorized_readings.count }}</span>
    </div>
    <div class="readings-list" data-category-id="null">
        {% for reading in uncategorized_readings %}
        <div class="reading-item" data-reading-id="{{ reading.pk }}">
            <span class="drag-handle reading-handle">
                <i class="bi bi-grip-vertical"></i>
            </span>
            <span class="reading-title">{{ reading.title }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not categories and not uncategorized_readings %}
<div class="text-center text-muted py-5">
    <i class="bi bi-book display-1"></i>
    <p class="mt-3">No readings to reorder.</p>
    <a href="{% url 'readings:add' %}" class="btn btn-primary">Add a Reading</a>
</div>
{% endif %}

<div id="save-indicator" class="save-indicator">
    <i class="bi bi-check-circle me-1"></i> Saved
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const csrfToken = '{{ csrf_token }}';

function showSaved() {
    const indicator = document.getElementById('save-indicator');
    indicator.style.display = 'block';
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 1500);
}

// Make categories sortable
const categoriesList = document.getElementById('categories-list');
if (categoriesList) {
    new Sortable(categoriesList, {
        animation: 150,
        handle: '.category-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
            // Get new order
            const order = Array.from(categoriesList.querySelectorAll('.category-card'))
                .map(el => el.dataset.categoryId);

            // Save to server
            fetch('{% url "readings:reorder_categories" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ order: order })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) showSaved();
            });
        }
    });
}

// Make readings within each category sortable
document.querySelectorAll('.readings-list').forEach(list => {
    new Sortable(list, {
        animation: 150,
        handle: '.reading-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
            // Get new order
            const order = Array.from(list.querySelectorAll('.reading-item'))
                .map(el => el.dataset.readingId);

            const categoryId = list.dataset.categoryId;

            // Save to server
            fetch('{% url "readings:reorder_readings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    category_id: categoryId === 'null' ? null : categoryId,
                    order: order
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) showSaved();
            });
        }
    });
});
</script>
{% endblock %}
