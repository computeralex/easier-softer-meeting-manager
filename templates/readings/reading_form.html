{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    .quill-container {
        background: white;
        min-height: 300px;
    }
    .ql-editor {
        min-height: 280px;
        line-height: 1.5;
    }
    .ql-editor p {
        margin-bottom: 1.5em;
    }
    .ql-editor li {
        line-height: 1.5;
        margin-bottom: 0.5em;
    }
    .ql-editor ul, .ql-editor ol {
        margin-bottom: 1.5em;
    }
    .ql-toolbar {
        background: #f8f9fa;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .ql-container {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    /* Soft line breaks should NOT add extra spacing */
    .ql-editor br {
        display: inline;
        margin: 0;
        line-height: inherit;
    }
    /* Editor font sizes */
    .editor-font-small .ql-editor { font-size: 16px; }
    .editor-font-medium .ql-editor { font-size: 20px; }
    .editor-font-large .ql-editor { font-size: 24px; }
    .editor-font-x-large .ql-editor { font-size: 28px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-book me-2"></i>{{ title }}</h1>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" id="reading-form">
            {% csrf_token %}

            <!-- Title -->
            <div class="mb-3">
                <label for="id_title" class="form-label">Title</label>
                <input type="text" name="title" class="form-control" id="id_title"
                       value="{{ form.title.value|default:'' }}" required maxlength="200">
                {% if form.title.errors %}
                <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                {% endif %}
            </div>

            <!-- Short Name -->
            <div class="mb-3">
                <label for="id_short_name" class="form-label">Short Name</label>
                <input type="text" name="short_name" class="form-control" id="id_short_name"
                       value="{{ form.short_name.value|default:'' }}" maxlength="50">
                <div class="form-text">Used in meeting format links (e.g., "12 Traditions" instead of full title)</div>
            </div>

            <!-- Category -->
            <div class="mb-3">
                <label for="id_category" class="form-label">Category</label>
                <select name="category" class="form-select" id="id_category">
                    <option value="">(No category)</option>
                    {% for cat in form.category.field.queryset %}
                    <option value="{{ cat.pk }}" {% if form.category.value|stringformat:"s" == cat.pk|stringformat:"s" %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Quill Editor -->
            <div class="mb-3">
                <label class="form-label">Content</label>
                <div id="quill-editor" class="quill-container editor-font-{{ readings_config.editor_font_size|default:'medium' }}"></div>
                <input type="hidden" name="content" id="id_content">
                {% if form.content.errors %}
                <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                {% endif %}
            </div>

            <!-- Copyright Notice -->
            <div class="mb-3">
                <label for="id_copyright_notice" class="form-label">Copyright Notice</label>
                <textarea name="copyright_notice" class="form-control" id="id_copyright_notice" rows="2">{{ form.copyright_notice.value|default:'' }}</textarea>
                <div class="form-text">Shown at bottom of reading in smaller italic text (e.g., source attribution)</div>
            </div>

            <!-- Notes -->
            <div class="mb-3">
                <label for="id_notes" class="form-label">Notes</label>
                <textarea name="notes" class="form-control" id="id_notes" rows="2">{{ form.notes.value|default:'' }}</textarea>
                <div class="form-text">Internal notes (not shown publicly)</div>
            </div>

            <!-- Visible -->
            <div class="mb-3 form-check">
                <input type="checkbox" name="is_active" class="form-check-input" id="id_is_active"
                       {% if form.is_active.value or not form.instance.pk %}checked{% endif %}>
                <label class="form-check-label" for="id_is_active">Visible (shown on public page)</label>
            </div>

            <!-- Noindex -->
            <div class="mb-3 form-check">
                <input type="checkbox" name="noindex" class="form-check-input" id="id_noindex"
                       {% if form.noindex.value %}checked{% endif %}>
                <label class="form-check-label" for="id_noindex">No Index (prevent search engines from indexing)</label>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Reading</button>
                <a href="{% url 'readings:list' %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
    // Register a custom Break blot for soft line breaks
    const Break = Quill.import('blots/break');
    const Embed = Quill.import('blots/embed');

    class SmartBreak extends Break {
        length() {
            return 1;
        }
        value() {
            return '\n';
        }
        insertInto(parent, ref) {
            Embed.prototype.insertInto.call(this, parent, ref);
        }
    }
    SmartBreak.blotName = 'break';
    SmartBreak.tagName = 'BR';
    Quill.register(SmartBreak);

    // Initialize Quill
    const quill = new Quill('#quill-editor', {
        theme: 'snow',
        placeholder: 'Enter the reading content here...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
            ],
            keyboard: {
                bindings: {
                    // Shift+Enter creates a soft line break (<br>) instead of new paragraph
                    linebreak: {
                        key: 13, // Enter
                        shiftKey: true,
                        handler: function(range) {
                            const currentLeaf = this.quill.getLeaf(range.index)[0];
                            const nextLeaf = this.quill.getLeaf(range.index + 1)[0];

                            this.quill.insertEmbed(range.index, 'break', true, 'user');

                            // Insert a zero-width space after to ensure cursor positioning works
                            if (nextLeaf === null || (currentLeaf.parent !== nextLeaf.parent)) {
                                this.quill.insertEmbed(range.index + 1, 'break', true, 'user');
                            }

                            this.quill.setSelection(range.index + 1, Quill.sources.SILENT);
                            return false;
                        }
                    }
                }
            }
        }
    });

    // Fix scroll jump when removing links - save and restore scroll position
    quill.on('selection-change', function(range, oldRange, source) {
        if (source === 'api') {
            const scrollTop = window.scrollY;
            requestAnimationFrame(() => {
                window.scrollTo(0, scrollTop);
            });
        }
    });

    // Load existing content if editing
    {% if form.content.value %}
    quill.root.innerHTML = "{{ form.content.value|escapejs }}";
    {% endif %}

    // On form submit, copy Quill content to hidden field
    document.getElementById('reading-form').addEventListener('submit', function(e) {
        const content = quill.root.innerHTML;
        // Check if content is empty (just whitespace or empty tags)
        const textContent = quill.getText().trim();
        if (!textContent) {
            e.preventDefault();
            alert('Please enter content for the reading.');
            return false;
        }
        document.getElementById('id_content').value = content;
    });
</script>
{% endblock %}
