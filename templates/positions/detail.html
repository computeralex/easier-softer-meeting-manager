{% extends "base.html" %}

{% block title %}{{ position.display_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'positions:list' %}" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left me-1"></i> Service
        </a>
        <h1 class="mt-2"><i class="bi bi-person-badge me-2"></i>{{ position.display_name }}</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'positions:assign' position.pk %}" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Assign User
        </a>
        <a href="{% url 'positions:update' position.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-pencil me-1"></i> Edit
        </a>
    </div>
</div>

{% if is_vacant %}
<div class="alert alert-danger">
    <i class="bi bi-x-circle me-1"></i>
    <strong>This position is vacant.</strong> Assign a user to fill this position.
</div>
{% elif is_available %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-1"></i>
    <strong>This position needs a primary holder.</strong>
    Someone may be covering it as a secondary responsibility, but a dedicated person is still needed.
</div>
{% endif %}
{% if has_multiple_primary %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-1"></i>
    <strong>Multiple primary holders.</strong> More than one person claims this as their primary position.
</div>
{% endif %}

<div class="row">
    <!-- Left column: Current holders and history -->
    <div class="col-lg-8">
        <!-- Primary Holder(s) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Primary Holder{% if primary_assignments.count > 1 %}s{% endif %}</h5>
            </div>
            <div class="card-body">
                {% if primary_assignments %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Started</th>
                                <th>Term Ends</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in primary_assignments %}
                            <tr>
                                <td>
                                    <strong>{{ assignment.user.get_full_name }}</strong>
                                    <div class="small text-muted">{{ assignment.user.email }}</div>
                                </td>
                                <td>{{ assignment.start_date|date:"M d, Y" }}</td>
                                <td>
                                    {{ assignment.expected_end_date|date:"M d, Y" }}
                                    <div class="small text-muted">
                                        {% if assignment.days_until_term_end > 0 %}
                                            {{ assignment.days_until_term_end }} days remaining
                                        {% elif assignment.days_until_term_end == 0 %}
                                            Ends today
                                        {% else %}
                                            {{ assignment.days_until_term_end|slice:"1:" }} days overdue
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if assignment.is_term_overdue %}
                                        <span class="badge bg-danger">Overdue</span>
                                    {% elif assignment.is_term_ending_soon %}
                                        <span class="badge bg-warning text-dark">Ending Soon</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'positions:end_term' position.pk assignment.pk %}"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-calendar-x"></i> End Term
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">
                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                    No primary holder. This position is available.
                    <a href="{% url 'positions:assign' position.pk %}">Assign a primary holder</a>.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Secondary Holder(s) (covering) -->
        {% if secondary_assignments %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-person-dash me-2"></i>Covering (Secondary)</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    These people are covering this position as a secondary responsibility.
                    The position still needs a primary holder.
                </p>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Their Primary Position</th>
                                <th>Started</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in secondary_assignments %}
                            <tr>
                                <td>
                                    {{ assignment.user.get_full_name }}
                                    <div class="small text-muted">{{ assignment.user.email }}</div>
                                </td>
                                <td>
                                    {% if assignment.user.primary_position %}
                                        {{ assignment.user.primary_position.display_name }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>{{ assignment.start_date|date:"M d, Y" }}</td>
                                <td class="text-end">
                                    <a href="{% url 'positions:end_term' position.pk assignment.pk %}"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-calendar-x"></i> End
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- History -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>History (Last 7 Years)</h5>
            </div>
            <div class="card-body">
                {% if history %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Term</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in history %}
                            <tr>
                                <td>{{ assignment.user.get_full_name }}</td>
                                <td>
                                    {{ assignment.start_date|date:"M Y" }} — {{ assignment.end_date|date:"M Y" }}
                                </td>
                                <td class="text-muted small">{{ assignment.notes|default:"-"|truncatechars:50 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No historical records for this position.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right column: Configuration -->
    <div class="col-lg-4">
        <!-- Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Term Length</dt>
                    <dd>{{ position.term_months }} months</dd>

                    {% if position.sobriety_requirement %}
                    <dt>Sobriety Requirement</dt>
                    <dd>{{ position.sobriety_requirement }}</dd>
                    {% endif %}

                    <dt>Public Directory</dt>
                    <dd>
                        {% if position.show_on_public_site %}
                            <span class="text-success"><i class="bi bi-eye"></i> Visible</span>
                        {% else %}
                            <span class="text-muted"><i class="bi bi-eye-slash"></i> Hidden</span>
                        {% endif %}
                    </dd>

                    <dt>Can Manage Users</dt>
                    <dd>
                        {% if position.can_manage_users %}
                            <span class="text-success"><i class="bi bi-check-circle"></i> Yes</span>
                        {% else %}
                            <span class="text-muted"><i class="bi bi-x-circle"></i> No</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Module Permissions -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Module Permissions</h5>
                <a href="{% url 'positions:permissions' position.pk %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-pencil"></i>
                </a>
            </div>
            <div class="card-body">
                {% if module_permissions %}
                <ul class="list-unstyled mb-0">
                    {% for perm in module_permissions %}
                    <li class="mb-2">
                        <i class="bi bi-{{ perm.icon }} me-1"></i>
                        {{ perm.name }}:
                        {% if perm.level == 'write' %}
                            <span class="badge bg-primary">Read & Write</span>
                        {% else %}
                            <span class="badge bg-secondary">Read Only</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">
                    No module permissions assigned.
                    <a href="{% url 'positions:permissions' position.pk %}">Configure permissions</a>.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Duties -->
        {% if position.duties %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Duties</h5>
            </div>
            <div class="card-body">
                {{ position.duties|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- SOP -->
        {% if position.sop %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Standard Operating Procedures</h5>
            </div>
            <div class="card-body">
                {{ position.sop|linebreaks }}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
